<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Character - Mordezzan</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        .character-form {
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .character-form h1 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #3498db;
        }

        .ability-scores {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .btn-cancel {
            background-color: #95a5a6;
            color: white;
        }

        .btn-cancel:hover {
            background-color: #7f8c8d;
        }

        .btn-submit {
            background-color: #2ecc71;
            color: white;
        }

        .btn-submit:hover {
            background-color: #27ae60;
        }

        .fighter-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .fighter-section h2 {
            color: #2c3e50;
            margin-top: 0;
        }
    </style>
</head>

<body>
    <div class="navbar">
        <div class="container">
            <a href="/" class="navbar-brand">Mordezzan</a>
            <ul class="navbar-menu">
                <li><a href="/">Dashboard</a></li>
                <li><a href="/profile" id="username-display"></a></li>
                <li><a href="#" id="logout-link">Logout</a></li>
            </ul>
        </div>
    </div>

    <div class="container">
        <div class="character-form">
            <h1>Edit Character: <span id="character-name"></span></h1>

            <form id="edit-character-form">
                <div class="form-section">
                    <h2>Character Information</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="character-name-input">Character Name</label>
                            <input type="text" id="character-name-input" name="name" required>
                        </div>

                        <div class="form-group">
                            <label for="character-class">Character Class</label>
                            <select id="character-class" name="class" required>
                                <option value="Fighter">Fighter</option>
                                <option value="Wizard">Wizard</option>
                                <option value="Cleric">Cleric</option>
                                <option value="Rogue">Rogue</option>
                                <option value="Druid">Druid</option>
                                <option value="Ranger">Ranger</option>
                                <option value="Paladin">Paladin</option>
                                <option value="Bard">Bard</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="hit-points">Hit Points</label>
                            <input type="number" id="hit-points" name="hit_points" min="1" required>
                        </div>

                        <div class="form-group">
                            <label for="experience-points">Experience Points</label>
                            <input type="number" id="experience-points" name="experience_points" min="0" required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>Ability Scores</h2>
                    <div class="ability-scores">
                        <div class="form-group">
                            <label for="strength">Strength</label>
                            <input type="number" id="strength" name="strength" min="3" max="18" required>
                        </div>
                        <div class="form-group">
                            <label for="dexterity">Dexterity</label>
                            <input type="number" id="dexterity" name="dexterity" min="3" max="18" required>
                        </div>
                        <div class="form-group">
                            <label for="constitution">Constitution</label>
                            <input type="number" id="constitution" name="constitution" min="3" max="18" required>
                        </div>
                        <div class="form-group">
                            <label for="intelligence">Intelligence</label>
                            <input type="number" id="intelligence" name="intelligence" min="3" max="18" required>
                        </div>
                        <div class="form-group">
                            <label for="wisdom">Wisdom</label>
                            <input type="number" id="wisdom" name="wisdom" min="3" max="18" required>
                        </div>
                        <div class="form-group">
                            <label for="charisma">Charisma</label>
                            <input type="number" id="charisma" name="charisma" min="3" max="18" required>
                        </div>
                    </div>
                </div>

                <div id="fighter-section" class="fighter-section" style="display: none;">
                    <h2>Fighter Level Information</h2>
                    <p>Based on your current experience (<span id="current-xp">0</span> XP), your character is level
                        <span id="fighter-level">1</span>.</p>
                    <p>Experience needed for next level: <span id="xp-needed">2000</span> XP</p>
                </div>

                <div class="form-actions">
                    <a href="/" class="btn btn-cancel">Cancel</a>
                    <button type="submit" class="btn btn-submit">Save Character</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Check if user is logged in
            const token = localStorage.getItem('authToken');
            const userId = localStorage.getItem('userId');
            const username = localStorage.getItem('username');

            if (!token || !userId) {
                // Redirect to login if not logged in
                window.location.href = '/auth/login-page';
                return;
            }

            // Display username in navbar
            document.getElementById('username-display').textContent = username;

            // Logout functionality
            document.getElementById('logout-link').addEventListener('click', function (e) {
                e.preventDefault();
                localStorage.removeItem('authToken');
                localStorage.removeItem('userId');
                localStorage.removeItem('username');
                window.location.href = '/auth/login-page';
            });

            // Get character ID from URL
            const pathParts = window.location.pathname.split('/');
            const characterId = pathParts[pathParts.length - 2]; // The format is /characters/:id/edit

            // Fetch character data
            fetchCharacterData(characterId);

            // Form submission
            document.getElementById('edit-character-form').addEventListener('submit', function (e) {
                e.preventDefault();
                updateCharacter(characterId);
            });

            // Class change handler
            document.getElementById('character-class').addEventListener('change', function () {
                updateFighterSection();
            });

            // Experience change handler
            document.getElementById('experience-points').addEventListener('input', function () {
                updateFighterLevel();
            });
        });

        // Fighter level thresholds
        const fighterLevels = [
            { level: 1, xp: 0 },
            { level: 2, xp: 2000 },
            { level: 3, xp: 4000 },
            { level: 4, xp: 8000 },
            { level: 5, xp: 16000 },
            { level: 6, xp: 32000 },
            { level: 7, xp: 64000 },
            { level: 8, xp: 128000 },
            { level: 9, xp: 256000 },
            { level: 10, xp: 384000 },
            { level: 11, xp: 512000 },
            { level: 12, xp: 640000 }
        ];

        function updateFighterSection() {
            const characterClass = document.getElementById('character-class').value;
            const fighterSection = document.getElementById('fighter-section');

            if (characterClass === 'Fighter') {
                fighterSection.style.display = 'block';
                updateFighterLevel();
            } else {
                fighterSection.style.display = 'none';
            }
        }

        function updateFighterLevel() {
            const xp = parseInt(document.getElementById('experience-points').value) || 0;
            document.getElementById('current-xp').textContent = xp;

            // Find the appropriate level for the XP
            let level = 1;
            let nextLevelXp = 2000;

            for (let i = fighterLevels.length - 1; i >= 0; i--) {
                if (xp >= fighterLevels[i].xp) {
                    level = fighterLevels[i].level;
                    if (i < fighterLevels.length - 1) {
                        nextLevelXp = fighterLevels[i + 1].xp;
                    } else {
                        nextLevelXp = fighterLevels[i].xp;
                    }
                    break;
                }
            }

            document.getElementById('fighter-level').textContent = level;

            // If max level reached
            if (level >= 12) {
                document.getElementById('xp-needed').innerHTML = '<i>Maximum level reached</i>';
            } else {
                document.getElementById('xp-needed').textContent = nextLevelXp;
            }
        }

        async function fetchCharacterData(characterId) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/characters/${characterId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch character details');
                }

                const character = await response.json();
                populateForm(character);
            } catch (error) {
                console.error('Error fetching character:', error);
                alert('Failed to load character: ' + error.message);
            }
        }

        function populateForm(character) {
            // Update page title and heading
            document.title = `Edit ${character.name} - Mordezzan`;
            document.getElementById('character-name').textContent = character.name;

            // Populate form fields
            document.getElementById('character-name-input').value = character.name;
            document.getElementById('character-class').value = character.class;
            document.getElementById('hit-points').value = character.hit_points;
            document.getElementById('experience-points').value = character.experience_points || 0;

            document.getElementById('strength').value = character.strength;
            document.getElementById('dexterity').value = character.dexterity;
            document.getElementById('constitution').value = character.constitution;
            document.getElementById('intelligence').value = character.intelligence;
            document.getElementById('wisdom').value = character.wisdom;
            document.getElementById('charisma').value = character.charisma;

            // Show fighter section if applicable
            updateFighterSection();
        }

        async function updateCharacter(characterId) {
            try {
                const token = localStorage.getItem('authToken');

                // Get form data
                const formData = {
                    name: document.getElementById('character-name-input').value,
                    class: document.getElementById('character-class').value,
                    hit_points: parseInt(document.getElementById('hit-points').value),
                    experience_points: parseInt(document.getElementById('experience-points').value),
                    level: parseInt(document.getElementById('fighter-level')?.textContent) || 1,
                    strength: parseInt(document.getElementById('strength').value),
                    dexterity: parseInt(document.getElementById('dexterity').value),
                    constitution: parseInt(document.getElementById('constitution').value),
                    intelligence: parseInt(document.getElementById('intelligence').value),
                    wisdom: parseInt(document.getElementById('wisdom').value),
                    charisma: parseInt(document.getElementById('charisma').value)
                };

                // Update the character
                const response = await fetch(`/api/characters/${characterId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to update character');
                }

                // Redirect to character view page
                window.location.href = `/characters/view/${characterId}`;
            } catch (error) {
                console.error('Error updating character:', error);
                alert('Failed to update character: ' + error.message);
            }
        }
    </script>
</body>

</html>