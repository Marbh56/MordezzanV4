<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Details - Mordezzan</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        .character-sheet {
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .character-sheet h1 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .character-section {
            margin-bottom: 30px;
        }

        .character-section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #3498db;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .character-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 16px;
            color: #2c3e50;
        }

        .ability-scores {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .ability-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .ability-label {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }

        .ability-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .ability-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .ability-modifiers {
            margin-top: 10px;
            font-size: 12px;
            text-align: left;
            border-top: 1px solid #e9ecef;
            padding-top: 8px;
        }

        .modifier-item {
            margin: 3px 0;
            color: #555;
            padding-bottom: 3px;
            border-bottom: 1px dotted #e9ecef;
            text-align: center;
        }

        .actions {
            margin-top: 30px;
            display: flex;
            gap: 10px;
        }

        .btn-edit {
            background-color: #f39c12;
            color: white;
        }

        .btn-edit:hover {
            background-color: #e67e22;
        }

        .btn-back {
            background-color: #95a5a6;
            color: white;
        }

        .btn-back:hover {
            background-color: #7f8c8d;
        }

        /* HP Control Styles */
        .hp-control {
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .hp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .btn-toggle {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 0;
            margin-left: 4px;
            color: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hp-update-container {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 100px;
            opacity: 1;
            transition: all 0.3s ease;
        }

        .hp-control.collapsed .hp-update-container {
            max-height: 0;
            margin-top: 0;
            opacity: 0;
            overflow: hidden;
        }

        .hp-actions,
        .hp-set {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #hp-change,
        #hp-set {
            width: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .btn-damage {
            background-color: #e74c3c;
            color: white;
            font-weight: bold;
            min-width: 40px;
        }

        .btn-heal {
            background-color: #2ecc71;
            color: white;
            font-weight: bold;
            min-width: 40px;
        }

        .btn-set-hp {
            background-color: #3498db;
            color: white;
        }

        /* XP Control Styles */
        .xp-control {
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .xp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .xp-update-container {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 100px;
            opacity: 1;
            transition: all 0.3s ease;
        }

        .xp-control.collapsed .xp-update-container {
            max-height: 0;
            margin-top: 0;
            opacity: 0;
            overflow: hidden;
        }

        .xp-actions,
        .xp-set {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #xp-change,
        #xp-set {
            width: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .btn-reward {
            background-color: #9b59b6;
            color: white;
            font-weight: bold;
            min-width: 40px;
        }

        .btn-set-xp {
            background-color: #3498db;
            color: white;
        }

        .fighter-level-info {
            margin-top: 10px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
        }

        /* Add a color for the next level indicator */
        .next-level {
            color: #9b59b6;
            font-weight: bold;
        }

        .save-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }

        .save-table th,
        .save-table td {
            padding: 8px 12px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .save-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
        }

        .save-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .save-info {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            text-align: center;
        }

        .ability-card {
            margin-bottom: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .ability-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 12px;
            color: #2c3e50;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ability-description {
            font-size: 14px;
            line-height: 1.6;
            color: #555;
            white-space: pre-line;
        }

        .ability-level {
            display: inline-block;
            padding: 2px 8px;
            font-size: 12px;
            color: white;
            background-color: #3498db;
            border-radius: 4px;
            margin-left: 10px;
        }

        /* Tab Styles */
        .tabs-container {
            margin-top: 20px;
        }

        .tabs-nav {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .tab-item {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            color: #7f8c8d;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }

        .tab-item:hover {
            color: #3498db;
        }

        .tab-item.active {
            color: #3498db;
            border-bottom: 2px solid #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Notes Tab */
        .notes-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }

        .notes-textarea {
            width: 100%;
            min-height: 200px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
            font-size: 14px;
            resize: vertical;
        }

        .notes-controls {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
        }

        .btn-save-notes {
            background-color: #3498db;
            color: white;
        }

        .btn-save-notes:hover {
            background-color: #2980b9;
        }

        /* Inventory Tab */
        .inventory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .inventory-title {
            font-size: 18px;
            color: #3498db;
            margin: 0;
        }

        .btn-add-item {
            background-color: #2ecc71;
            color: white;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
        }

        .inventory-table th,
        .inventory-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .inventory-table th {
            background-color: #f8f9fa;
            color: #2c3e50;
            font-weight: bold;
        }

        .inventory-table tr:hover {
            background-color: #f8f9fa;
        }

        .item-actions {
            display: flex;
            gap: 8px;
        }

        .btn-item-edit,
        .btn-item-delete {
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-item-edit {
            background-color: #f39c12;
            color: white;
        }

        .btn-item-delete {
            background-color: #e74c3c;
            color: white;
        }

        /* Spells Tab */
        .spells-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .spell-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #9b59b6;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .spell-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .spell-level {
            display: inline-block;
            padding: 2px 6px;
            background-color: #9b59b6;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .spell-description {
            font-size: 14px;
            color: #555;
            margin-bottom: 10px;
        }

        .spell-meta {
            font-size: 12px;
            color: #7f8c8d;
            border-top: 1px dotted #e9ecef;
            padding-top: 8px;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>

<body>
    <div class="navbar">
        <div class="container">
            <a href="/" class="navbar-brand">Mordezzan</a>
            <ul class="navbar-menu">
                <li><a href="/">Dashboard</a></li>
                <li><a href="/profile" id="username-display"></a></li>
                <li><a href="#" id="logout-link">Logout</a></li>
            </ul>
        </div>
    </div>

    <div class="container">
        <div class="character-sheet">
            <h1>
                <span id="character-name">Loading...</span>
                <span id="character-level-class"></span>
            </h1>

            <!-- Top Character Information - Always Visible -->
            <div class="character-section">
                <div class="character-info">
                    <div class="info-item">
                        <span class="info-label">Name</span>
                        <span class="info-value" id="info-name">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Level</span>
                        <span class="info-value" id="info-level">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Class</span>
                        <span class="info-value" id="info-class">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Hit Dice</span>
                        <span class="info-value" id="info-hit-dice">Loading...</span>
                    </div>

                    <!-- HP Control Panel -->
                    <div class="info-item hp-control collapsed" id="hp-control-panel">
                        <span class="info-label hp-header">
                            <span>Hit Points: <span id="info-hp">Loading...</span></span>
                            <button class="btn btn-toggle" id="toggle-hp-panel">
                                <span class="toggle-icon">⚔️</span>
                            </button>
                        </span>
                        <div class="hp-update-container" id="hp-update-container">
                            <div class="hp-actions">
                                <button class="btn btn-damage" id="btn-damage">-</button>
                                <input type="number" id="hp-change" min="1" value="1">
                                <button class="btn btn-heal" id="btn-heal">+</button>
                            </div>
                            <div class="hp-set">
                                <input type="number" id="hp-set" min="0" placeholder="Set exact HP">
                                <button class="btn btn-set-hp" id="btn-set-hp">Set</button>
                            </div>
                        </div>
                    </div>

                    <!-- XP Control Panel -->
                    <div class="info-item xp-control collapsed" id="xp-control-panel">
                        <span class="info-label xp-header">
                            <span>Experience: <span id="info-experience">Loading...</span></span>
                            <button class="btn btn-toggle" id="toggle-xp-panel">
                                <span class="toggle-icon">📈</span>
                            </button>
                        </span>
                        <div class="xp-update-container" id="xp-update-container">
                            <div class="xp-actions">
                                <input type="number" id="xp-change" min="1" value="100">
                                <button class="btn btn-reward" id="btn-reward">+</button>
                            </div>
                            <div class="xp-set">
                                <input type="number" id="xp-set" min="0" placeholder="Set exact XP">
                                <button class="btn btn-set-xp" id="btn-set-xp">Set</button>
                            </div>
                            <div class="fighter-level-info" id="fighter-level-info" style="display: none;">
                                <div>Current level: <span id="current-level">-</span></div>
                                <div>Next level at: <span id="next-level-xp" class="next-level">-</span> XP</div>
                                <div>XP needed: <span id="xp-needed">-</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <div class="tabs-container">
                <div class="tabs-nav">
                    <div class="tab-item active" data-tab="character-tab">Character</div>
                    <div class="tab-item" data-tab="spells-tab" id="spells-tab-nav">Spells</div>
                    <div class="tab-item" data-tab="inventory-tab">Inventory</div>
                    <div class="tab-item" data-tab="notes-tab">Notes</div>
                </div>

                <!-- Character Tab -->
                <div class="tab-content active" id="character-tab">
                    <div id="saving-throws-section" style="display: none;">
                        <h2>Saving Throws</h2>
                        <div class="saving-throws-container">
                            <div class="save-info">
                                <p>Base Save: <strong id="base-save">-</strong></p>
                                <p>Roll this number or higher on a d20 to save successfully (with modifiers)</p>
                            </div>
                            <table class="save-table">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Modifier</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Death</td>
                                        <td id="death-mod">+0</td>
                                    </tr>
                                    <tr>
                                        <td>Transformation</td>
                                        <td id="transform-mod">+0</td>
                                    </tr>
                                    <tr>
                                        <td>Device</td>
                                        <td id="device-mod">+0</td>
                                    </tr>
                                    <tr>
                                        <td>Avoidance</td>
                                        <td id="avoidance-mod">+0</td>
                                    </tr>
                                    <tr>
                                        <td>Sorcery</td>
                                        <td id="sorcery-mod">+0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="character-section">
                        <h2>Ability Scores</h2>
                        <div class="ability-scores">
                            <div class="ability-item">
                                <div class="ability-label">Strength</div>
                                <div class="ability-value" id="ability-str">-</div>
                                <div class="ability-modifiers">
                                    <div class="modifier-item">Attack: <span id="str-attack-mod">-</span></div>
                                    <div class="modifier-item">Damage: <span id="str-damage-adj">-</span></div>
                                    <div class="modifier-item">Test: <span id="str-test">-</span></div>
                                    <div class="modifier-item">Feat: <span id="str-feat">-</span></div>
                                </div>
                            </div>
                            <div class="ability-item">
                                <div class="ability-label">Dexterity</div>
                                <div class="ability-value" id="ability-dex">-</div>
                                <div class="ability-modifiers">
                                    <div class="modifier-item">Attack: <span id="dex-attack-mod">-</span></div>
                                    <div class="modifier-item">Defense: <span id="dex-defense-adj">-</span></div>
                                    <div class="modifier-item">Test: <span id="dex-test">-</span></div>
                                    <div class="modifier-item">Feat: <span id="dex-feat">-</span></div>
                                </div>
                            </div>
                            <div class="ability-item">
                                <div class="ability-label">Constitution</div>
                                <div class="ability-value" id="ability-con">-</div>
                                <div class="ability-modifiers">
                                    <div class="modifier-item">HP: <span id="con-hp-mod">-</span></div>
                                    <div class="modifier-item">Save: <span id="con-save-mod">-</span></div>
                                    <div class="modifier-item">Survival: <span id="con-survival">-</span></div>
                                    <div class="modifier-item">Test: <span id="con-test">-</span></div>
                                </div>
                            </div>
                            <div class="ability-item">
                                <div class="ability-label">Intelligence</div>
                                <div class="ability-value" id="ability-int">-</div>
                                <div class="ability-modifiers">
                                    <div class="modifier-item">Lang: <span id="int-lang-mod">-</span></div>
                                    <div class="modifier-item">Magic: <span id="int-magic-bonus">-</span></div>
                                    <div class="modifier-item">Chance: <span id="int-magic-chance">-</span></div>
                                </div>
                            </div>
                            <div class="ability-item">
                                <div class="ability-label">Wisdom</div>
                                <div class="ability-value" id="ability-wis">-</div>
                                <div class="ability-modifiers">
                                    <div class="modifier-item">Will: <span id="wis-will-mod">-</span></div>
                                    <div class="modifier-item">Cleric: <span id="wis-cleric-bonus">-</span></div>
                                    <div class="modifier-item">Chance: <span id="wis-cleric-chance">-</span></div>
                                </div>
                            </div>
                            <div class="ability-item">
                                <div class="ability-label">Charisma</div>
                                <div class="ability-value" id="ability-cha">-</div>
                                <div class="ability-modifiers">
                                    <div class="modifier-item">React: <span id="cha-reaction-mod">-</span></div>
                                    <div class="modifier-item">Followers: <span id="cha-followers">-</span></div>
                                    <div class="modifier-item">Turn: <span id="cha-turn-mod">-</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="fighter-abilities-section" style="display: none;">
                        <h2>Fighter Abilities</h2>
                        <div class="fighter-abilities-container" id="fighter-abilities-container">
                            <!-- Abilities will be dynamically inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Spells Tab -->
                <div class="tab-content" id="spells-tab">
                    <h2>Spells</h2>
                    <div class="spells-container" id="spells-container">
                        <!-- Will be populated with AJAX -->
                        <div class="spell-loading" id="spells-loading">
                            Loading spells...
                        </div>
                        <div class="spell-empty" id="spells-empty" style="display: none;">
                            No spells available for this character.
                        </div>
                    </div>
                </div>

                <!-- Inventory Tab -->
                <div class="tab-content" id="inventory-tab">
                    <div class="inventory-header">
                        <h2 class="inventory-title">Inventory</h2>
                        <button class="btn btn-add-item" id="btn-add-item">Add Item</button>
                    </div>
                    <div class="inventory-container" id="inventory-container">
                        <!-- Will be populated with AJAX -->
                        <div class="inventory-loading" id="inventory-loading">
                            Loading inventory...
                        </div>
                        <table class="inventory-table" id="inventory-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Quantity</th>
                                    <th>Weight</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-items">
                                <!-- Items will be inserted here -->
                            </tbody>
                        </table>
                        <div class="inventory-empty" id="inventory-empty" style="display: none;">
                            No items in inventory. Click "Add Item" to get started.
                        </div>
                    </div>
                </div>

                <!-- Notes Tab -->
                <div class="tab-content" id="notes-tab">
                    <h2>Character Notes</h2>
                    <div class="notes-container">
                        <textarea class="notes-textarea" id="character-notes"
                            placeholder="Enter your character notes here..."></textarea>
                        <div class="notes-controls">
                            <button class="btn btn-save-notes" id="btn-save-notes">Save Notes</button>
                        </div>
                        <p class="notes-message" id="notes-message" style="display: none;"></p>
                    </div>
                </div>
            </div>

            <div class="actions">
                <a href="#" class="btn btn-edit" id="edit-character-btn">Edit Character</a>
                <a href="/" class="btn btn-back">Back to Dashboard</a>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentHP = 0;
        let currentXP = 0;
        let currentClass = '';
        let fighterLevels = [];
        let currentLevel = 1;
        let characterId = '';

        document.addEventListener('DOMContentLoaded', function () {
            // Check if user is logged in
            const token = localStorage.getItem('authToken');
            const userId = localStorage.getItem('userId');
            const username = localStorage.getItem('username');

            if (!token || !userId) {
                // Redirect to login if not logged in
                window.location.href = '/auth/login-page';
                return;
            }

            // Display username in navbar
            document.getElementById('username-display').textContent = username;

            // Logout functionality
            document.getElementById('logout-link').addEventListener('click', function (e) {
                e.preventDefault();
                localStorage.removeItem('authToken');
                localStorage.removeItem('userId');
                localStorage.removeItem('username');
                window.location.href = '/auth/login-page';
            });

            // Get character ID from URL
            characterId = getCharacterIdFromURL();

            if (characterId) {
                fetchCharacterDetails(characterId);
                // If character is a fighter, fetch fighter level data
                fetchFighterLevels();

                // Update edit button link
                document.getElementById('edit-character-btn').href = `/characters/${characterId}/edit`;
            } else {
                window.location.href = '/'; // Redirect to dashboard if no character ID
            }

            // Set up HP toggle functionality
            setupHPControls();

            // Set up XP toggle functionality
            setupXPControls();

            // Set up tabs functionality
            setupTabs();
        });

        function setupTabs() {
            const tabItems = document.querySelectorAll('.tab-item');
            const tabContents = document.querySelectorAll('.tab-content');

            tabItems.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    tabItems.forEach(item => item.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    // Add active class to clicked tab
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');

                    // Load tab-specific content if needed
                    if (tabId === 'spells-tab') {
                        fetchSpells();
                    } else if (tabId === 'inventory-tab') {
                        fetchInventory();
                    }
                });
            });
        }

        function getCharacterIdFromURL() {
            const pathParts = window.location.pathname.split('/');
            return pathParts[pathParts.length - 1];
        }

        function setupHPControls() {
            const hpControl = document.getElementById('hp-control-panel');
            const toggleButton = document.getElementById('toggle-hp-panel');
            const hpHeader = document.querySelector('.hp-header');

            function toggleHPPanel() {
                hpControl.classList.toggle('collapsed');
            }

            // Allow clicking either the button or the header to toggle
            toggleButton.addEventListener('click', function (e) {
                e.stopPropagation();
                toggleHPPanel();
            });

            hpHeader.addEventListener('click', toggleHPPanel);

            // HP update event listeners
            document.getElementById('btn-damage').addEventListener('click', function (e) {
                e.stopPropagation();
                const damageAmount = parseInt(document.getElementById('hp-change').value) || 0;
                if (damageAmount <= 0) return;

                const newHP = Math.max(0, currentHP - damageAmount);
                updateCharacterHP(newHP);
            });

            document.getElementById('btn-heal').addEventListener('click', function (e) {
                e.stopPropagation();
                const healAmount = parseInt(document.getElementById('hp-change').value) || 0;
                if (healAmount <= 0) return;

                const newHP = currentHP + healAmount;
                updateCharacterHP(newHP);
            });

            document.getElementById('btn-set-hp').addEventListener('click', function (e) {
                e.stopPropagation();
                const newHP = parseInt(document.getElementById('hp-set').value);
                if (isNaN(newHP) || newHP < 0) return;

                updateCharacterHP(newHP);
            });
        }

        function setupXPControls() {
            const xpControl = document.getElementById('xp-control-panel');
            const toggleButton = document.getElementById('toggle-xp-panel');
            const xpHeader = document.querySelector('.xp-header');

            function toggleXPPanel() {
                xpControl.classList.toggle('collapsed');
            }

            // Allow clicking either the button or the header to toggle
            toggleButton.addEventListener('click', function (e) {
                e.stopPropagation();
                toggleXPPanel();
            });

            xpHeader.addEventListener('click', toggleXPPanel);

            // XP update event listeners
            document.getElementById('btn-reward').addEventListener('click', function (e) {
                e.stopPropagation();
                const rewardAmount = parseInt(document.getElementById('xp-change').value) || 0;
                if (rewardAmount <= 0) return;

                const newXP = currentXP + rewardAmount;
                updateCharacterXP(newXP);
            });

            document.getElementById('btn-set-xp').addEventListener('click', function (e) {
                e.stopPropagation();
                const newXP = parseInt(document.getElementById('xp-set').value);
                if (isNaN(newXP) || newXP < 0) return;

                updateCharacterXP(newXP);
            });
        }

        function updateHPDisplay(hp) {
            currentHP = hp;
            document.getElementById('info-hp').textContent = hp;
        }

        function updateXPDisplay(xp, level, characterClass) {
            currentXP = xp;
            currentLevel = level;
            currentClass = characterClass;

            document.getElementById('info-experience').textContent = xp.toLocaleString();
            document.getElementById('xp-set').value = xp;

            // Update fighter-specific level info if applicable
            updateFighterLevelInfo();
        }

        function updateFighterLevelInfo() {
            const fighterLevelInfo = document.getElementById('fighter-level-info');

            if (currentClass === 'Fighter' && fighterLevels.length > 0) {
                fighterLevelInfo.style.display = 'block';

                document.getElementById('current-level').textContent = currentLevel;

                // Find next level XP
                let nextLevelXP = null;
                let xpNeeded = 0;

                for (let i = 0; i < fighterLevels.length; i++) {
                    if (fighterLevels[i].level > currentLevel) {
                        nextLevelXP = fighterLevels[i].experience_points;
                        xpNeeded = nextLevelXP - currentXP;
                        break;
                    }
                }

                if (nextLevelXP !== null) {
                    document.getElementById('next-level-xp').textContent = nextLevelXP.toLocaleString();
                    document.getElementById('xp-needed').textContent = xpNeeded.toLocaleString();
                } else {
                    // Max level reached
                    document.getElementById('next-level-xp').textContent = "Max level reached";
                    document.getElementById('xp-needed').textContent = "0";
                }
            } else {
                fighterLevelInfo.style.display = 'none';
            }
        }

        async function updateCharacterHP(newHP) {
            try {
                const token = localStorage.getItem('authToken');

                const response = await fetch(`/api/characters/${characterId}/hp`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ hit_points: newHP })
                });

                if (!response.ok) {
                    throw new Error('Failed to update hit points');
                }

                const character = await response.json();
                updateHPDisplay(character.hit_points);
                return character;
            } catch (error) {
                console.error('Error updating hit points:', error);
                alert('Failed to update hit points: ' + error.message);
            }
        }

        async function updateCharacterXP(newXP) {
            try {
                const token = localStorage.getItem('authToken');

                const response = await fetch(`/api/characters/${characterId}/xp`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ experience_points: newXP })
                });

                if (!response.ok) {
                    throw new Error('Failed to update experience points');
                }

                const character = await response.json();

                // Update the UI with new character data
                updateXPDisplay(character.experience_points, character.level, character.class);

                // If level changed, update level display
                document.getElementById('info-level').textContent = character.level;
                document.getElementById('character-level-class').textContent = `Level ${character.level} ${character.class}`;

                return character;
            } catch (error) {
                console.error('Error updating experience points:', error);
                alert('Failed to update experience points: ' + error.message);
            }
        }

        async function fetchFighterLevels() {
            try {
                const token = localStorage.getItem('authToken');

                const response = await fetch('/api/fighter-levels', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    fighterLevels = await response.json();

                    // Update the fighter level info display if character is a fighter
                    if (currentClass === 'Fighter') {
                        updateFighterLevelInfo();
                    }
                }
            } catch (error) {
                console.error('Error fetching fighter levels:', error);
                // Silently fail - not critical
            }
        }

        async function fetchCharacterDetails(charId) {
            try {
                const token = localStorage.getItem('authToken');

                const response = await fetch(`/api/characters/${charId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch character details');
                }

                const character = await response.json();
                displayCharacterDetails(character);

                // Show/hide spells tab based on character class
                toggleSpellsTab(character.class);
            } catch (error) {
                console.error('Error fetching character details:', error);
                alert('Failed to load character details: ' + error.message);
            }
        }

        function toggleSpellsTab(characterClass) {
            const spellsTab = document.getElementById('spells-tab-nav');
            // Only show spells tab for magic-using classes
            if (['Wizard', 'Cleric', 'Druid', 'Bard', 'Paladin'].includes(characterClass)) {
                spellsTab.style.display = 'block';
            } else {
                spellsTab.style.display = 'none';
            }
        }

        async function fetchSpells() {
            try {
                const token = localStorage.getItem('authToken');
                const spellsContainer = document.getElementById('spells-container');
                const spellsLoading = document.getElementById('spells-loading');
                const spellsEmpty = document.getElementById('spells-empty');

                spellsLoading.style.display = 'block';
                spellsEmpty.style.display = 'none';

                const response = await fetch(`/api/characters/${characterId}/spells`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch spells');
                }

                const spells = await response.json();
                spellsLoading.style.display = 'none';

                if (spells.length === 0) {
                    spellsEmpty.style.display = 'block';
                    return;
                }

                // Clear previous spells
                spellsContainer.innerHTML = '';

                // Add each spell
                spells.forEach(spell => {
                    const spellCard = document.createElement('div');
                    spellCard.className = 'spell-card';

                    const spellName = document.createElement('div');
                    spellName.className = 'spell-name';
                    spellName.textContent = spell.name;

                    const spellLevel = document.createElement('div');
                    spellLevel.className = 'spell-level';
                    spellLevel.textContent = `Level ${spell.level}`;

                    const spellDescription = document.createElement('div');
                    spellDescription.className = 'spell-description';
                    spellDescription.textContent = spell.description;

                    const spellMeta = document.createElement('div');
                    spellMeta.className = 'spell-meta';
                    spellMeta.innerHTML = `
                        <span>Range: ${spell.range || 'N/A'}</span>
                        <span>Duration: ${spell.duration || 'N/A'}</span>
                    `;

                    spellCard.appendChild(spellName);
                    spellCard.appendChild(spellLevel);
                    spellCard.appendChild(spellDescription);
                    spellCard.appendChild(spellMeta);
                    spellsContainer.appendChild(spellCard);
                });
            } catch (error) {
                console.error('Error fetching spells:', error);
                document.getElementById('spells-loading').style.display = 'none';
                document.getElementById('spells-empty').style.display = 'block';
                document.getElementById('spells-empty').textContent = 'Failed to load spells: ' + error.message;
            }
        }

        async function fetchInventory() {
            try {
                const token = localStorage.getItem('authToken');
                const inventoryTable = document.getElementById('inventory-table');
                const inventoryItems = document.getElementById('inventory-items');
                const inventoryLoading = document.getElementById('inventory-loading');
                const inventoryEmpty = document.getElementById('inventory-empty');

                inventoryLoading.style.display = 'block';
                inventoryTable.style.display = 'none';
                inventoryEmpty.style.display = 'none';

                const response = await fetch(`/api/inventories/character/${characterId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch inventory');
                }

                const inventory = await response.json();
                inventoryLoading.style.display = 'none';

                if (!inventory || !inventory.items || inventory.items.length === 0) {
                    inventoryEmpty.style.display = 'block';
                    return;
                }

                // Clear previous items
                inventoryItems.innerHTML = '';

                // Add each item
                inventory.items.forEach(item => {
                    const row = document.createElement('tr');

                    row.innerHTML = `
                        <td>${item.name}</td>
                        <td>${item.type}</td>
                        <td>${item.quantity}</td>
                        <td>${item.weight ? item.weight + ' lbs' : 'N/A'}</td>
                        <td>${item.notes || ''}</td>
                        <td class="item-actions">
                            <button class="btn btn-item-edit" data-id="${item.id}">Edit</button>
                            <button class="btn btn-item-delete" data-id="${item.id}">Delete</button>
                        </td>
                    `;

                    inventoryItems.appendChild(row);
                });

                // Add event listeners for item actions
                document.querySelectorAll('.btn-item-edit').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const itemId = this.getAttribute('data-id');
                        // Call edit item function with itemId
                        // editInventoryItem(itemId);
                        alert('Edit item functionality will be implemented soon');
                    });
                });

                document.querySelectorAll('.btn-item-delete').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const itemId = this.getAttribute('data-id');
                        // Call delete item function with itemId
                        // deleteInventoryItem(itemId);
                        alert('Delete item functionality will be implemented soon');
                    });
                });

                // Set up "Add Item" button functionality
                document.getElementById('btn-add-item').addEventListener('click', function () {
                    // Call add item function
                    // addInventoryItem();
                    alert('Add item functionality will be implemented soon');
                });

                inventoryTable.style.display = 'table';
            } catch (error) {
                console.error('Error fetching inventory:', error);
                document.getElementById('inventory-loading').style.display = 'none';
                document.getElementById('inventory-empty').style.display = 'block';
                document.getElementById('inventory-empty').textContent = 'Failed to load inventory: ' + error.message;
            }
        }

        function formatModifier(value) {
            return value >= 0 ? `+${value}` : value.toString();
        }

        function updateSavingThrows(character) {
            // Base save is the character's saving throw
            const baseSave = character.saving_throw;

            // Update base save display
            document.getElementById('base-save').textContent = baseSave;

            // Set modifiers (defaults to 0 for all categories)
            document.getElementById('death-mod').textContent = '+0';
            document.getElementById('transform-mod').textContent = '+0';
            document.getElementById('device-mod').textContent = '+0';
            document.getElementById('avoidance-mod').textContent = '+0';
            document.getElementById('sorcery-mod').textContent = '+0';
        }

        function displayFighterAbilities(character) {
            const fighterAbilitiesSection = document.getElementById('fighter-abilities-section');
            const fighterAbilitiesContainer = document.getElementById('fighter-abilities-container');

            if (character.class === 'Fighter' && character.abilities && character.abilities.length > 0) {
                // Clear previous abilities
                fighterAbilitiesContainer.innerHTML = '';

                // Add each ability
                character.abilities.forEach(ability => {
                    const abilityCard = document.createElement('div');
                    abilityCard.className = 'ability-card';

                    const abilityHeader = document.createElement('div');
                    abilityHeader.className = 'ability-name';
                    abilityHeader.textContent = ability.name;

                    if (ability.min_level > 1) {
                        const levelBadge = document.createElement('span');
                        levelBadge.className = 'ability-level';
                        levelBadge.textContent = `Level ${ability.min_level}+`;
                        abilityHeader.appendChild(levelBadge);
                    }

                    const abilityDescription = document.createElement('div');
                    abilityDescription.className = 'ability-description';
                    abilityDescription.textContent = ability.description;

                    abilityCard.appendChild(abilityHeader);
                    abilityCard.appendChild(abilityDescription);
                    fighterAbilitiesContainer.appendChild(abilityCard);
                });

                // Show the section
                fighterAbilitiesSection.style.display = 'block';
            } else {
                // Hide the section if not a fighter or no abilities
                fighterAbilitiesSection.style.display = 'none';
            }
        }

        // Set up character notes functionality
        function setupNotesTab() {
            const saveButton = document.getElementById('btn-save-notes');
            const notesTextarea = document.getElementById('character-notes');
            const notesMessage = document.getElementById('notes-message');

            // Load existing notes
            loadCharacterNotes();

            // Save notes button
            saveButton.addEventListener('click', async function () {
                const notes = notesTextarea.value;
                try {
                    // In the future, implement an API endpoint for saving notes
                    // For now, just store in localStorage
                    localStorage.setItem(`character_notes_${characterId}`, notes);

                    // Show success message
                    notesMessage.textContent = 'Notes saved successfully!';
                    notesMessage.style.color = '#2ecc71';
                    notesMessage.style.display = 'block';

                    // Hide message after 3 seconds
                    setTimeout(() => {
                        notesMessage.style.display = 'none';
                    }, 3000);
                } catch (error) {
                    console.error('Error saving notes:', error);
                    notesMessage.textContent = 'Failed to save notes. Please try again.';
                    notesMessage.style.color = '#e74c3c';
                    notesMessage.style.display = 'block';
                }
            });
        }

        function loadCharacterNotes() {
            const notesTextarea = document.getElementById('character-notes');
            // For now, just retrieve from localStorage
            const savedNotes = localStorage.getItem(`character_notes_${characterId}`);
            if (savedNotes) {
                notesTextarea.value = savedNotes;
            }
        }

        function displayCharacterDetails(character) {
            // Set page title
            document.title = `${character.name} - Mordezzan`;

            // Update header
            document.getElementById('character-name').textContent = character.name;
            document.getElementById('character-level-class').textContent = `Level ${character.level} ${character.class}`;

            // Update basic info
            document.getElementById('info-name').textContent = character.name;
            document.getElementById('info-class').textContent = character.class;
            document.getElementById('info-level').textContent = character.level;
            document.getElementById('info-hit-dice').textContent = character.hit_dice || '-';

            // Update HP display and set field
            updateHPDisplay(character.hit_points);
            document.getElementById('hp-set').value = character.hit_points;

            // Update XP display and set field
            updateXPDisplay(character.experience_points || 0, character.level, character.class);

            const savingThrowsSection = document.getElementById('saving-throws-section');
            if (character.class === 'Fighter' && character.saving_throw) {
                updateSavingThrows(character);
                savingThrowsSection.style.display = 'block';
            } else {
                savingThrowsSection.style.display = 'none';
            }

            // Set modifiers with the actual save bonuses
            document.getElementById('death-mod').textContent = formatModifier(character.death_save_bonus || 0);
            document.getElementById('transform-mod').textContent = formatModifier(character.transformation_save_bonus || 0);
            document.getElementById('device-mod').textContent = '+0';
            document.getElementById('avoidance-mod').textContent = '+0';
            document.getElementById('sorcery-mod').textContent = '+0';

            // Strength
            document.getElementById('ability-str').textContent = character.strength;
            document.getElementById('str-attack-mod').textContent = formatModifier(character.Melee_modifier);
            document.getElementById('str-damage-adj').textContent = formatModifier(character.damage_adjustment);
            document.getElementById('str-test').textContent = character.strength_test || '-';
            document.getElementById('str-feat').textContent = character.extra_strength_feat || '-';

            // Dexterity
            document.getElementById('ability-dex').textContent = character.dexterity;
            document.getElementById('dex-attack-mod').textContent = formatModifier(character.Ranged_modifier);
            document.getElementById('dex-defense-adj').textContent = formatModifier(character.defence_adjustment);
            document.getElementById('dex-test').textContent = character.dexterity_test || '-';
            document.getElementById('dex-feat').textContent = character.extra_dexterity_feat || '-';

            // Constitution
            document.getElementById('ability-con').textContent = character.constitution;
            document.getElementById('con-hp-mod').textContent = formatModifier(character.HP_modifier);
            document.getElementById('con-save-mod').textContent = formatModifier(character.poison_rad_modifier);
            document.getElementById('con-survival').textContent = character.trauma_survival || '-';
            document.getElementById('con-test').textContent = character.constitution_test || '-';

            // Intelligence
            document.getElementById('ability-int').textContent = character.intelligence;
            document.getElementById('int-lang-mod').textContent = character.language_modifier || '-';
            document.getElementById('int-magic-bonus').textContent = character.magicians_bonus || '-';
            document.getElementById('int-magic-chance').textContent = character.magicians_chance || '-';

            // Wisdom
            document.getElementById('ability-wis').textContent = character.wisdom;
            document.getElementById('wis-will-mod').textContent = formatModifier(character.willpower_modifier);
            document.getElementById('wis-cleric-bonus').textContent = character.cleric_bonus || '-';
            document.getElementById('wis-cleric-chance').textContent = character.cleric_chance || '-';

            // Charisma
            document.getElementById('ability-cha').textContent = character.charisma;
            document.getElementById('cha-reaction-mod').textContent = formatModifier(character.reaction_modifier);
            document.getElementById('cha-followers').textContent = character.max_followers || '-';
            document.getElementById('cha-turn-mod').textContent = formatModifier(character.undead_turning_modifier);

            // Display fighter abilities
            displayFighterAbilities(character);

            // Setup notes tab
            setupNotesTab();
        }
    </script>
</body>