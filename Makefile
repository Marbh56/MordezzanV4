.PHONY: build run test migrate sqlc clean test-integration test-integration-simple

build:
	go build -o bin/server cmd/server/main.go

run: build
	./bin/server

test:
	go test ./...

test-unit:
	go test ./internal/repositories/... ./internal/controllers/... ./internal/middleware/... -v

test-integration:
	bash integration_test/test-run-script.sh

test-integration-simple:
	bash integration_test/test-run-script.sh --simple

test-all: test-unit test-integration

integration-test: test-integration

create-migration:
	@if [ -z "$(name)" ]; then \
		echo "Error: Migration name is required. Usage: make create-migration name=migration_name"; \
		exit 1; \
	fi
	@echo "Creating migration: $(name)"
	@timestamp=$$(date +%Y%m%d%H%M%S); \
	filename="internal/repositories/db/migrations/$${timestamp}_$(name).sql"; \
	echo "-- +goose Up\n-- SQL in this section is executed when the migration is applied\n\n\n-- +goose Down\n-- SQL in this section is executed when the migration is rolled back\n" > "$$filename"; \
	echo "Created migration file: $$filename"

migrate:
	goose -dir internal/repositories/db/migrations sqlite3 ./myproject.db up

sqlc:
	sqlc generate

clean:
	go clean

dev-setup: sqlc migrate build

tree:
	@if command -v tree > /dev/null; then \
		tree -I "node_modules|vendor|.git" --dirsfirst -F > project_structure.txt; \
		echo "Project structure saved to project_structure.txt"; \
	else \
		find . -type d -not -path "*/\.*" -not -path "*/node_modules/*" -not -path "*/vendor/*" | sort > project_structure.txt; \
		find . -type f -not -path "*/\.*" -not -path "*/node_modules/*" -not -path "*/vendor/*" | sort >> project_structure.txt; \
		echo "Project structure saved to project_structure.txt (using find command)"; \
	fi

repo-dashboard:
	repomix --remove-comments --remove-empty-lines \
		--ignore "**/controllers/ammo_controller.go,**/controllers/armor_controller.go,**/controllers/spell_controller.go,**/controllers/shield_controller.go,**/controllers/weapon_controller.go,**/controllers/equipment_controller.go,**/controllers/magic_items_controller.go,**/controllers/potion_controller.go,**/controllers/ring_controller.go,**/controllers/spell_scroll_controller.go,**/controllers/container_controller.go,**/controllers/treasure_controller.go,**/controllers/inventory_controller.go,**/controllers/spell_casting_controller.go,**/controllers/character_controller.go,**/models/ammo.go,**/models/armor.go,**/models/shield.go,**/models/ring.go,**/models/potion.go,**/models/weapon.go,**/models/equipment.go,**/models/magic_items.go,**/models/spell_scrolls.go,**/models/containers.go,**/models/treasure.go,**/models/spell*.go,**/models/class_data.go,**/models/encumbrance.go,**/models/inventory.go,**/models/character.go,**/repositories/ammo_repository.go,**/repositories/armor_repository.go,**/repositories/shield_repository.go,**/repositories/ring_repository.go,**/repositories/potion_repository.go,**/repositories/weapon_repository.go,**/repositories/equipment_repository.go,**/repositories/magic_items_repository.go,**/repositories/spell_scroll_repository.go,**/repositories/container_repository.go,**/repositories/treasure_repository.go,**/repositories/spell_repository.go,**/repositories/character_repository.go,**/repositories/class_repository.go,**/repositories/inventory_repository.go,**/repositories/spell_casting_repository.go,**/services/class_service.go,**/services/encumbrance_service.go,**/services/spell_service.go,**/queries/**,**/*_test.go,**/db/migrations/**,**/db/inserts/**,**/sqlc/**,**/integration_test/**,**/*.log,**/*.db,**/bin/**,**/tmp/**,**/.git/**,**/node_modules/**,**/.DS_Store,**/*.sqlite,**/*.sqlite3,**/test_logs/**,**/web/static/css/spells_tab.css,**/web/static/css/inventory_tab.css,**/web/static/js/spells_tab.js,**/web/static/js/inventory_tab.js,**/web/templates/ammo.html,**/web/templates/armor.html,**/web/templates/potion.html,**/web/templates/ring.html,**/web/templates/shield.html,**/web/templates/weapon.html,**/web/templates/magic_items.html,**/web/templates/containers.html,**/web/templates/equipment.html,**/web/templates/spell*.html,**/web/templates/inventory.html,**/web/templates/character*.html"

repo-character:
	repomix --remove-comments --remove-empty-lines \
		--ignore "**/controllers/ammo_controller.go,**/controllers/armor_controller.go,**/controllers/spell_controller.go,**/controllers/shield_controller.go,**/controllers/weapon_controller.go,**/controllers/equipment_controller.go,**/controllers/magic_items_controller.go,**/controllers/potion_controller.go,**/controllers/ring_controller.go,**/controllers/spell_scroll_controller.go,**/controllers/container_controller.go,**/controllers/treasure_controller.go,**/controllers/inventory_controller.go,**/controllers/spell_casting_controller.go,**/controllers/auth_controller.go,**/controllers/user_controller.go,**/controllers/base_controller.go,**/models/ammo.go,**/models/armor.go,**/models/shield.go,**/models/ring.go,**/models/potion.go,**/models/weapon.go,**/models/equipment.go,**/models/magic_items.go,**/models/spell_scrolls.go,**/models/containers.go,**/models/treasure.go,**/models/spell*.go,**/models/encumbrance.go,**/models/inventory.go,**/models/user.go,**/repositories/**,**/services/**,**/middleware/**,**/db/migrations/**,**/db/inserts/**,**/sqlc/**,**/integration_test/**,**/*.log,**/*.db,**/bin/**,**/tmp/**,**/.git/**,**/node_modules/**,**/.DS_Store,**/*.sqlite,**/*.sqlite3,**/test_logs/**,**/web/static/css/*tab.css,**/web/static/js/*tab.js,**/web/templates/ammo.html,**/web/templates/armor.html,**/web/templates/potion.html,**/web/templates/ring.html,**/web/templates/shield.html,**/web/templates/weapon.html,**/web/templates/magic_items.html,**/web/templates/containers.html,**/web/templates/equipment.html,**/web/templates/spell*.html,**/web/templates/inventory.html,**/web/templates/login.html,**/web/templates/register.html,**/web/templates/home.html,**/web/templates/dashboard.html"

repo-character-inventory:
	repomix --remove-comments --remove-empty-lines \
		--ignore "**/db/migrations/**,**/db/inserts/**,**/sqlc/**,**/integration_test/**,**/*.log,**/*.db,**/bin/**,**/tmp/**,**/.git/**,**/node_modules/**,**/.DS_Store,**/*.sqlite,**/*.sqlite3,**/test_logs/**,**/controllers/ammo_controller.go,**/controllers/armor_controller.go,**/controllers/spell_controller.go,**/controllers/shield_controller.go,**/controllers/weapon_controller.go,**/controllers/equipment_controller.go,**/controllers/magic_items_controller.go,**/controllers/potion_controller.go,**/controllers/ring_controller.go,**/controllers/spell_scroll_controller.go,**/controllers/container_controller.go,**/controllers/treasure_controller.go,**/controllers/spell_casting_controller.go,**/controllers/auth_controller.go,**/controllers/user_controller.go,**/controllers/base_controller.go,**/models/ammo.go,**/models/armor.go,**/models/shield.go,**/models/ring.go,**/models/potion.go,**/models/weapon.go,**/models/equipment.go,**/models/magic_items.go,**/models/spell_scrolls.go,**/models/containers.go,**/models/treasure.go,**/models/spell*.go,**/models/class_data.go,**/models/user.go,**/repositories/ammo_repository.go,**/repositories/armor_repository.go,**/repositories/shield_repository.go,**/repositories/ring_repository.go,**/repositories/potion_repository.go,**/repositories/weapon_repository.go,**/repositories/equipment_repository.go,**/repositories/magic_items_repository.go,**/repositories/spell_scroll_repository.go,**/repositories/container_repository.go,**/repositories/treasure_repository.go,**/repositories/spell_repository.go,**/repositories/class_repository.go,**/repositories/spell_casting_repository.go,**/repositories/user_repository.go,**/repositories/user_repository_test.go,**/repositories/repository.go,**/services/class_service.go,**/services/email_service.go,**/services/spell_service.go,**/queries/**,**/*_test.go,**/web/static/css/spells_tab.css,**/web/static/js/spells_tab.js,**/web/templates/ammo.html,**/web/templates/armor.html,**/web/templates/potion.html,**/web/templates/ring.html,**/web/templates/shield.html,**/web/templates/weapon.html,**/web/templates/magic_items.html,**/web/templates/containers.html,**/web/templates/equipment.html,**/web/templates/spell*.html,**/web/templates/login.html,**/web/templates/register.html,**/web/templates/home.html,**/web/templates/dashboard.html,**/web/templates/character_create.html,**/web/static/js/auth.js,**/web/static/js/dashboard.js,**/web/static/js/home.js,**/web/static/js/create_form.js"

repo-combat:
	repomix --remove-comments --remove-empty-lines \
		--ignore "**/controllers/ammo_controller.go,**/controllers/armor_controller.go,**/controllers/spell_controller.go,**/controllers/shield_controller.go,**/controllers/equipment_controller.go,**/controllers/magic_items_controller.go,**/controllers/potion_controller.go,**/controllers/ring_controller.go,**/controllers/spell_scroll_controller.go,**/controllers/container_controller.go,**/controllers/treasure_controller.go,**/controllers/inventory_controller.go,**/controllers/spell_casting_controller.go,**/controllers/user_controller.go,**/controllers/auth_controller.go,**/models/ammo.go,**/models/armor.go,**/models/shield.go,**/models/ring.go,**/models/potion.go,**/models/weapon.go,**/models/equipment.go,**/models/magic_items.go,**/models/spell_scrolls.go,**/models/containers.go,**/models/treasure.go,**/models/spell*.go,**/models/class_data.go,**/models/encumbrance.go,**/models/inventory.go,**/models/user.go,**/repositories/ammo_repository.go,**/repositories/armor_repository.go,**/repositories/shield_repository.go,**/repositories/ring_repository.go,**/repositories/potion_repository.go,**/repositories/weapon_repository.go,**/repositories/equipment_repository.go,**/repositories/magic_items_repository.go,**/repositories/spell_scroll_repository.go,**/repositories/container_repository.go,**/repositories/treasure_repository.go,**/repositories/spell_repository.go,**/repositories/class_repository.go,**/repositories/inventory_repository.go,**/repositories/spell_casting_repository.go,**/repositories/user_repository.go,**/services/encumbrance_service.go,**/services/spell_service.go,**/services/email_service.go,**/queries/**,**/db/migrations/**,**/db/inserts/**,**/sqlc/**,**/integration_test/**,**/*.log,**/*.db,**/bin/**,**/tmp/**,**/.git/**,**/node_modules/**,**/.DS_Store,**/*.sqlite,**/*.sqlite3,**/test_logs/**,**/web/static/css/spells_tab.css,**/web/static/css/inventory_tab.css,**/web/static/js/spells_tab.js,**/web/static/js/inventory_tab.js,**/web/templates/ammo.html,**/web/templates/armor.html,**/web/templates/potion.html,**/web/templates/ring.html,**/web/templates/shield.html,**/web/templates/weapon.html,**/web/templates/magic_items.html,**/web/templates/containers.html,**/web/templates/equipment.html,**/web/templates/spell*.html,**/web/templates/inventory.html,**/web/templates/login.html,**/web/templates/register.html,**/web/static/js/auth.js,**/web/static/js/dashboard.js,**/web/static/js/home.js,**/web/static/js/inventory_tab.js,**/web/templates/dashboard.html,**/web/templates/home.html"

repo-inventory-hands:
	repomix --remove-comments --remove-empty-lines \
		--ignore "**/controllers/ammo_controller.go,**/controllers/armor_controller.go,**/controllers/spell_controller.go,**/controllers/shield_controller.go,**/controllers/weapon_controller.go,**/controllers/equipment_controller.go,**/controllers/magic_items_controller.go,**/controllers/potion_controller.go,**/controllers/ring_controller.go,**/controllers/spell_scroll_controller.go,**/controllers/container_controller.go,**/controllers/treasure_controller.go,**/controllers/auth_controller.go,**/controllers/user_controller.go,**/controllers/spell_casting_controller.go,**/models/ammo.go,**/models/armor.go,**/models/shield.go,**/models/ring.go,**/models/potion.go,**/models/weapon.go,**/models/equipment.go,**/models/magic_items.go,**/models/spell_scrolls.go,**/models/containers.go,**/models/treasure.go,**/models/spell*.go,**/models/class_data.go,**/models/user.go,**/models/weapons.go,**/models/rings.go,**/models/shields.go,**/repositories/ammo_repository.go,**/repositories/armor_repository.go,**/repositories/shield_repository.go,**/repositories/rings_repository.go,**/repositories/potion_repository.go,**/repositories/weapon_repository.go,**/repositories/equipment_repository.go,**/repositories/magic_items_repository.go,**/repositories/spell_scroll_repository.go,**/repositories/container_repository.go,**/repositories/treasure_repository.go,**/repositories/spell_repository.go,**/repositories/class_repository.go,**/repositories/spell_casting_repository.go,**/repositories/user_repository.go,**/services/class_service.go,**/services/spell_service.go,**/services/email_service.go,**/queries/**,**/*_test.go,**/db/migrations/**,**/db/inserts/**,**/sqlc/**,**/integration_test/**,**/*.log,**/*.db,**/bin/**,**/tmp/**,**/.git/**,**/node_modules/**,**/.DS_Store,**/*.sqlite,**/*.sqlite3,**/test_logs/**,**/web/static/css/spells_tab.css,**/web/static/js/spells_tab.js,**/web/static/js/auth.js,**/web/static/js/dashboard.js,**/web/static/js/home.js,**/web/static/js/create_form.js,**/web/templates/ammo.html,**/web/templates/armor.html,**/web/templates/potion.html,**/web/templates/ring.html,**/web/templates/shield.html,**/web/templates/weapon.html,**/web/templates/magic_items.html,**/web/templates/containers.html,**/web/templates/equipment.html,**/web/templates/spell*.html,**/web/templates/login.html,**/web/templates/register.html,**/web/templates/home.html,**/web/templates/dashboard.html,**/web/templates/character_create.html"

user-char-bug:
	repomix --remove-comments --remove-empty-lines \
		--ignore "**/controllers/ammo_controller.go,**/controllers/armor_controller.go,**/controllers/container_controller.go,**/controllers/equipment_controller.go,**/controllers/inventory_controller.go,**/controllers/magic_items_controller.go,**/controllers/potion_controller.go,**/controllers/ring_controller.go,**/controllers/shield_controller.go,**/controllers/spell_casting_controller.go,**/controllers/spell_controller.go,**/controllers/spell_scroll_controller.go,**/controllers/treasure_controller.go,**/controllers/weapon_controller.go,**/models/ammo.go,**/models/armor.go,**/models/class_data.go,**/models/containers.go,**/models/encumbrance.go,**/models/equipment.go,**/models/equipment_slots.go,**/models/inventory.go,**/models/magic_items.go,**/models/potion.go,**/models/rings.go,**/models/shields.go,**/models/spell_scrolls.go,**/models/spells.go,**/models/treasure.go,**/models/weapons.go,**/repositories/ammo_repository.go,**/repositories/armor_repository.go,**/repositories/class_repository.go,**/repositories/container_repository.go,**/repositories/equipment_repository.go,**/repositories/inventory_repository.go,**/repositories/magic_items_repository.go,**/repositories/potion_repository.go,**/repositories/rings_repository.go,**/repositories/shields_repository.go,**/repositories/spell_casting_repository.go,**/repositories/spell_repository.go,**/repositories/spell_scroll_repository.go,**/repositories/treasure_repository.go,**/repositories/weapon_repository.go,**/repositories/db/migrations/202503*_insert_*.sql,**/repositories/db/queries/ammo.sql,**/repositories/db/queries/armor.sql,**/repositories/db/queries/class.sql,**/repositories/db/queries/containers.sql,**/repositories/db/queries/equipment.sql,**/repositories/db/queries/inventory.sql,**/repositories/db/queries/magic_items.sql,**/repositories/db/queries/potion.sql,**/repositories/db/queries/rings.sql,**/repositories/db/queries/shields.sql,**/repositories/db/queries/spell_casting.sql,**/repositories/db/queries/spell_scrolls.sql,**/repositories/db/queries/spells.sql,**/repositories/db/queries/treasure.sql,**/repositories/db/queries/weapons.sql,**/repositories/db/sqlc/ammo.sql.go,**/repositories/db/sqlc/armor.sql.go,**/repositories/db/sqlc/class.sql.go,**/repositories/db/sqlc/containers.sql.go,**/repositories/db/sqlc/equipment.sql.go,**/repositories/db/sqlc/inventory.sql.go,**/repositories/db/sqlc/magic_items.sql.go,**/repositories/db/sqlc/potion.sql.go,**/repositories/db/sqlc/rings.sql.go,**/repositories/db/sqlc/shields.sql.go,**/repositories/db/sqlc/spell_casting.sql.go,**/repositories/db/sqlc/spell_scrolls.sql.go,**/repositories/db/sqlc/spellbooks.sql.go,**/repositories/db/sqlc/spells.sql.go,**/repositories/db/sqlc/treasure.sql.go,**/repositories/db/sqlc/weapons.sql.go,**/services/class_service.go,**/services/email_service.go,**/services/encumbrance_service.go,**/services/spell_service.go,**/web/static/css/**,**/web/static/js/combat_tab.js,**/web/static/js/dashboard.js,**/web/static/js/home.js,**/web/static/js/inventory_tab.js,**/web/templates/ammo.html,**/web/templates/armor.html,**/web/templates/combat_tab.html,**/web/templates/containers.html,**/web/templates/dashboard.html,**/web/templates/equipment.html,**/web/templates/home.html,**/web/templates/inventory.html,**/web/templates/magic_items.html,**/web/templates/potion.html,**/web/templates/ring.html,**/web/templates/shield.html,**/web/templates/spell*.html,**/web/templates/weapon.html,**/*_test.go,**/integration_test/**,**/*.log,**/*.db,**/bin/**,**/tmp/**,**/.git/**,**/node_modules/**,**/.DS_Store,**/*.sqlite,**/*.sqlite3,**/test_logs/**"
repo-abilities:
	repomix --remove-comments --remove-empty-lines \
		--ignore "**/controllers/ammo_controller.go,**/controllers/armor_controller.go,**/controllers/armor_class_controller.go,**/controllers/spell_controller.go,**/controllers/shield_controller.go,**/controllers/weapon_controller.go,**/controllers/equipment_controller.go,**/controllers/magic_items_controller.go,**/controllers/potion_controller.go,**/controllers/ring_controller.go,**/controllers/spell_scroll_controller.go,**/controllers/container_controller.go,**/controllers/treasure_controller.go,**/controllers/inventory_controller.go,**/controllers/spell_casting_controller.go,**/controllers/auth_controller.go,**/controllers/user_controller.go,**/controllers/weapon_mastery_controller.go,**/controllers/weapon_stats_controller.go,**/controllers/base_controller.go,**/models/ammo.go,**/models/armor.go,**/models/shield.go,**/models/ring.go,**/models/potion.go,**/models/weapon.go,**/models/equipment.go,**/models/magic_items.go,**/models/spell_scrolls.go,**/models/containers.go,**/models/treasure.go,**/models/user.go,**/models/encumbrance.go,**/models/equipment_slots.go,**/models/inventory.go,**/models/weapon_mastery.go,**/app/app.go,**/auth/**,**/contextkeys/**,**/errors/**,**/logger/**,**/middleware/**,**/repositories/ammo_repository.go,**/repositories/armor_repository.go,**/repositories/shield_repository.go,**/repositories/rings_repository.go,**/repositories/potion_repository.go,**/repositories/weapon_repository.go,**/repositories/equipment_repository.go,**/repositories/magic_items_repository.go,**/repositories/spell_scroll_repository.go,**/repositories/container_repository.go,**/repositories/treasure_repository.go,**/repositories/inventory_repository.go,**/repositories/user_repository.go,**/repositories/user_repository_test.go,**/repositories/weapon_mastery_repository.go,**/repositories/repository.go,**/repositories/db/queries/ammo.sql,**/repositories/db/queries/armor.sql,**/repositories/db/queries/containers.sql,**/repositories/db/queries/equipment.sql,**/repositories/db/queries/inventory.sql,**/repositories/db/queries/magic_items.sql,**/repositories/db/queries/potion.sql,**/repositories/db/queries/rings.sql,**/repositories/db/queries/shields.sql,**/repositories/db/queries/spell_scrolls.sql,**/repositories/db/queries/treasure.sql,**/repositories/db/queries/user.sql,**/repositories/db/queries/weapon_masteries.sql,**/repositories/db/queries/weapons.sql,**/repositories/db/sqlc/ammo.sql.go,**/repositories/db/sqlc/armor.sql.go,**/repositories/db/sqlc/containers.sql.go,**/repositories/db/sqlc/equipment.sql.go,**/repositories/db/sqlc/inventory.sql.go,**/repositories/db/sqlc/magic_items.sql.go,**/repositories/db/sqlc/potion.sql.go,**/repositories/db/sqlc/rings.sql.go,**/repositories/db/sqlc/shields.sql.go,**/repositories/db/sqlc/spell_scrolls.sql.go,**/repositories/db/sqlc/treasure.sql.go,**/repositories/db/sqlc/user.sql.go,**/repositories/db/sqlc/weapons.sql.go,**/repositories/db/sqlc/weapon_masteries.sql.go,**/services/armor_class_service.go,**/services/email_service.go,**/services/encumbrance_service.go,**/services/weapon_stats_service.go,**/cmd/server/main.go,**/pkg/**,**/test_logs/**,**/web/static/css/**,**/web/static/images/**,**/web/static/html/**,**/web/static/js/inventory_tab.js,**/web/static/js/auth.js,**/web/static/js/dashboard.js,**/web/static/js/home.js,**/web/static/js/create_form.js,**/web/static/js/weapon_mastery.js,**/web/static/js/weapon_stats.js,**/web/static/js/combat_tab.js,**/web/templates/**,**/integration_test/**,**/*.log,**/*.db,**/bin/**,**/tmp/**,**/.git/**,**/node_modules/**,**/.DS_Store,**/*.sqlite,**/*.sqlite3,**/*.sql,**/todo.txt,**/project_structure.txt,**/dashboard_structure.txt,**/go.mod,**/go.sum,**/sqlc.yaml,**/repomix-output.txt"